<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è²·ã„ç‰©ã‚¯ã‚¨ã‚¹ãƒˆDX - ç‰¹åˆ¥ã‚¨ãƒªã‚¢ç‰ˆ</title>
  <style>
    /* --- CSSè¨­å®š --- */
    * {
      box-sizing: border-box;
      touch-action: manipulation;
    }

    body {
      font-family: 'Courier New', monospace;
      text-align: center;
      background-color: #111;
      color: #eee;
      margin: 0;
      padding: 5px;
      image-rendering: pixelated; 
    }

    h1 { margin: 5px 0; font-size: 18px; color: #ffd700; text-shadow: 1px 1px #000; }
    h2, h3 { margin: 5px 0; }

    .hidden { display: none !important; }

    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
    }

    #status-bar {
      display: flex;
      justify-content: space-around;
      width: 100%;
      background: #222;
      padding: 4px;
      border: 2px solid #555;
      border-radius: 4px;
      margin-bottom: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    #gold-display { color: #ffeb3b; }
    #mp-display { color: #88f; }

    #message-box {
      background-color: #333;
      color: #fff;
      border: 2px solid #eee;
      padding: 4px;
      margin-bottom: 5px;
      width: 100%;
      font-size: 12px;
      min-height: 24px;
    }

    #area-display {
      background: linear-gradient(45deg, #444, #666);
      color: #fff;
      padding: 3px 8px;
      margin-bottom: 5px;
      font-size: 11px;
      font-weight: bold;
      border-radius: 4px;
      text-shadow: 1px 1px 0 #000;
    }

    #screen-area {
      position: relative;
      width: 424px; 
      height: 424px;
      border: 4px solid #777;
      background-color: #000;
      overflow: hidden;
    }

    #field {
      display: grid;
      grid-template-columns: repeat(7, 60px);
      grid-template-rows: repeat(7, 60px);
      gap: 0;
    }

    .cell {
      width: 60px;
      height: 60px;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: transparent;
    }

    /* é€šå¸¸ã‚¿ã‚¤ãƒ« */
    .tile-empty { background-color: #7cba3f; }
    .tile-city  { background-color: #c2b280; border: 2px solid #5a3e19; }
    .tile-wall  { background-color: #555; }
    
    /* ã‚¨ãƒªã‚¢åˆ¥ã‚¿ã‚¤ãƒ« */
    .tile-witch-area { background-color: #4a148c; }
    .tile-dragon-area { background-color: #b71c1c; }
    .tile-poison-area { background-color: #2e7d32; }
    .tile-slime-area { background-color: #0277bd; }
    .tile-maou-area { background-color: #1a1a1a; }
    .tile-minion-area { background-color: #424242; }
    
    /* ã‚¨ãƒªã‚¢åˆ¥ã®æ•µ */
    .tile-enemy { 
      background-color: #7cba3f;
      position: relative;
    }
    .tile-enemy::after {
      content: 'ğŸ‘¾';
      font-size: 30px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
    }

    .tile-witch-enemy::after { content: 'ğŸ§™â€â™€ï¸'; }
    .tile-dragon-enemy::after { content: 'ğŸ‰'; }
    .tile-poison-enemy::after { content: 'â˜ ï¸'; }
    .tile-slime-enemy::after { content: 'ğŸŸ¢'; }
    .tile-maou-enemy::after { content: 'ğŸ‘¹'; }
    .tile-minion-enemy::after { content: 'ğŸ˜ˆ'; }

    /* ç‰¹åˆ¥ãªå»ºç‰© */
    .tile-special-building {
      position: relative;
      background: radial-gradient(circle, #ffd700, #ff6b00);
      border: 3px solid #ff0000;
    }
    .tile-special-building::after {
      font-size: 35px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    .tile-witch-house::after { content: 'ğŸšï¸'; }
    .tile-dragon-nest::after { content: 'ğŸ”ï¸'; }
    .tile-maou-castle::after { content: 'ğŸ°'; }

    .player-marker {
      position: absolute;
      top: 180px;
      left: 180px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      z-index: 10;
      filter: drop-shadow(0 0 4px yellow);
    }
    .player-marker::after {
      content: 'ğŸ¦¸';
    }

    .overlay-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 20;
      overflow-y: auto;
    }

    #town { background-color: #3e2723; }
    #battle { 
      background: linear-gradient(to bottom, #000046, #1cb5e0);
      justify-content: space-between;
    }

    .shop-content {
      width: 100%;
      max-height: 280px;
      overflow-y: auto;
    }

    .hp-box {
      width: 100%;
      text-align: left;
      font-size: 14px;
      text-shadow: 1px 1px 0 #000;
      padding: 5px;
    }

    .enemy-img {
      width: 200px;
      height: 200px;
      object-fit: contain;
      margin: 10px auto;
      filter: drop-shadow(4px 4px 6px rgba(0,0,0,0.7));
      image-rendering: pixelated;
    }

    #battle-log-container {
      width: 100%;
      background: rgba(0,0,0,0.6);
      border: 2px solid #fff;
      padding: 5px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #battle-log { font-size: 14px; font-weight: bold; }

    #command-area {
      width: 100%;
      margin-bottom: 5px;
    }

    #main-commands, .sub-menu {
      display: flex;
      justify-content: center;
      gap: 5px;
      flex-wrap: wrap;
    }

    button {
      background: #333;
      color: #fff;
      border: 2px solid #777;
      padding: 8px 12px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background: #555; border-color: #fff; }
    button:active { background: #777; }

    .item-btn { 
      width: 90%; 
      margin: 5px auto; 
      display: block;
      text-align: left;
      padding: 10px;
    }

    .legendary-item {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      font-weight: bold;
      border: 3px solid #ff6b00;
      animation: glow 1.5s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px #ffd700; }
      50% { box-shadow: 0 0 20px #ffd700; }
    }

    #controller {
      margin-top: 10px;
      padding: 10px;
      background: #222;
      border-radius: 10px;
    }
    .d-pad {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .d-row { display: flex; gap: 5px; margin: 2px; }
    #controller button {
      width: 60px;
      height: 60px;
      font-size: 24px;
      background: #444;
      border-color: #222;
      box-shadow: 2px 2px 0 #000;
    }
    #controller button:active {
      transform: translate(2px, 2px);
      box-shadow: none;
    }

    #music-control {
      margin: 5px 0;
      font-size: 12px;
    }
    #music-toggle {
      background: #a44;
      padding: 6px 12px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>è²·ã„ç‰©ã‚¯ã‚¨ã‚¹ãƒˆ DX - ç‰¹åˆ¥ã‚¨ãƒªã‚¢ç‰ˆ</h1>
    
    <div id="music-control">
      <button id="music-toggle">ğŸ”‡ éŸ³æ¥½OFF</button>
    </div>

    <div id="area-display">ç¾åœ¨åœ°: å¹³åŸã‚¨ãƒªã‚¢</div>

    <div id="status-bar">
      <div id="gold-display">ğŸ’°:0 G</div>
      <div id="weapon-display">âš”ï¸:ãªã—</div>
      <div id="mp-display">ğŸ’§:10</div>
    </div>
    <div id="message-box" class="hidden"></div>

    <div id="screen-area">
      <div id="field"></div>

      <div id="town" class="hidden overlay-screen">
        <h2 id="town-name">è¡—</h2>
        <div id="shop-icon" style="font-size: 50px;">ğŸ </div>
        <div id="shop-description" style="margin: 10px 0;"></div>
        <div id="current-shop" class="shop-content"></div>
        <p style="font-size:11px; margin-top:10px;">ç§»å‹•ã‚­ãƒ¼ã§è¡—ã‚’å‡ºã‚‹</p>
      </div>

      <div id="battle" class="hidden overlay-screen">
        <div class="hp-box">
          <div id="player-hp">å‹‡è€…HP:20</div>
          <div id="enemy-hp">æ•µHP:10</div>
        </div>
        
        <img id="battle-enemy-img" class="enemy-img" src="" alt="Enemy">
        
        <div id="battle-log-container">
          <div id="battle-log">é­”ç‰©ãŒã‚ã‚‰ã‚ã‚ŒãŸ!</div>
        </div>
        
        <div id="command-area">
          <div id="main-commands">
            <button class="command">æˆ¦ã†</button>
            <button class="command">ã¾ã»ã†</button>
            <button class="command">ã©ã†ã</button>
            <button class="command">ã«ã’ã‚‹</button>
          </div>
          <div id="magic-menu" class="hidden sub-menu">
            <button class="magic-btn" data-name="ãƒ•ã‚¡ã‚¤ã‚¢" data-cost="3">ğŸ”¥ãƒ•ã‚¡ã‚¤ã‚¢(3)</button>
            <button class="magic-btn" data-name="ãƒ’ãƒ¼ãƒ«" data-cost="5">âœ¨ãƒ’ãƒ¼ãƒ«(5)</button>
          </div>
          <div id="item-menu" class="hidden sub-menu">
            <button class="item-use-btn" data-name="å›å¾©è–¬">ğŸ§ªå›å¾©è–¬</button>
            <button class="item-use-btn" data-name="ãƒã‚¸ãƒƒã‚¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼">ğŸ’§MW</button>
            <button class="item-use-btn" data-name="ç‰¹åŠ¹è–¬">âœ¨ç‰¹åŠ¹è–¬</button>
          </div>
        </div>
      </div>
    </div>

    <div id="controller">
      <div class="d-pad">
        <div class="d-row"><button id="up">â†‘</button></div>
        <div class="d-row">
          <button id="left">â†</button>
          <button id="down">â†“</button>
          <button id="right">â†’</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- è¦ç´ ã®å–å¾— ---
      const field = document.getElementById("field");
      const screenArea = document.getElementById("screen-area");
      const town = document.getElementById("town");
      const townName = document.getElementById("town-name");
      const shopIcon = document.getElementById("shop-icon");
      const shopDescription = document.getElementById("shop-description");
      const currentShop = document.getElementById("current-shop");
      const battle = document.getElementById("battle");
      const battleLog = document.getElementById("battle-log");
      const battleEnemyImg = document.getElementById("battle-enemy-img");
      const playerHPText = document.getElementById("player-hp");
      const enemyHPText = document.getElementById("enemy-hp");
      const goldDisplay = document.getElementById("gold-display");
      const weaponDisplay = document.getElementById("weapon-display");
      const mpDisplay = document.getElementById("mp-display");
      const messageBox = document.getElementById("message-box");
      const magicMenu = document.getElementById("magic-menu");
      const itemMenu = document.getElementById("item-menu");
      const musicToggle = document.getElementById("music-toggle");
      const areaDisplay = document.getElementById("area-display");

      // --- æ•µç”»åƒã®ãƒªã‚¹ãƒˆ ---
      const enemyImages = {
        normal: ["enemy7.jpg", "enemy8.jpg", "enemy9.jpg", "enemy10.jpg"],
        witch: ["enemy9.jpg"], // ã‚´ãƒ¼ã‚¹ãƒˆç³»
        dragon: ["enemy7.jpg"], // ç‚ç³»
        poison: ["enemy8.jpg"], // ã‚«ã‚¨ãƒ«ç³»
        slime: ["enemy8.jpg"],  // ã‚¹ãƒ©ã‚¤ãƒ 
        maou: ["maou.jpg"],     // é­”ç‹
        minion: ["enemy10.jpg"] // çˆ†å¼¾ç³»
      };

      // --- ã‚¨ãƒªã‚¢å®šç¾© ---
      const areaNames = {
        normal: "å¹³åŸã‚¨ãƒªã‚¢",
        witch: "é­”å¥³ã®æ£®",
        dragon: "ãƒ‰ãƒ©ã‚´ãƒ³ã®å·£",
        poison: "æ¯’ã®æ²¼",
        slime: "ã‚¹ãƒ©ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³",
        maou: "é­”ç‹ã®åŸ",
        minion: "é­”ç‹ã®éƒ¨ä¸‹ã‚¨ãƒªã‚¢"
      };

      // --- éŸ³æ¥½ã®è¨­å®š ---
      const fieldBGM = new Audio("felde.mp3");
      const battleBGM = new Audio("batle.mp3");
      
      fieldBGM.loop = true;
      battleBGM.loop = true;
      fieldBGM.volume = 0.4;
      battleBGM.volume = 0.4;

      let musicEnabled = false;

      musicToggle.addEventListener("click", () => {
        musicEnabled = !musicEnabled;
        if (musicEnabled) {
          musicToggle.textContent = "ğŸ”Š éŸ³æ¥½ON";
          musicToggle.style.background = "#4a4";
          if (inBattle) {
            battleBGM.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼(Battle):", e));
          } else {
            fieldBGM.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼(Field):", e));
          }
        } else {
          musicToggle.textContent = "ğŸ”‡ éŸ³æ¥½OFF";
          musicToggle.style.background = "#a44";
          fieldBGM.pause();
          battleBGM.pause();
        }
      });

      // --- ã‚²ãƒ¼ãƒ å¤‰æ•° ---
      const MAP_SIZE = 50;
      const VIEW_SIZE = 7;
      const VIEW_RADIUS = Math.floor(VIEW_SIZE / 2);

      let mapData = [];
      let areaData = [];
      let cityData = {};
      let playerX = Math.floor(MAP_SIZE / 2);
      let playerY = Math.floor(MAP_SIZE / 2);
      
      let inTown = false;
      let inBattle = false;
      let currentEnemy = null;

      let playerHP = 30;
      const maxHP = 30;
      let playerMP = 10;
      const maxMP = 10;
      let enemyHP = 10;
      let gold = 50;
      let weapon = "ãªã—";
      let items = { 
        "å›å¾©è–¬": 2,
        "ãƒã‚¸ãƒƒã‚¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼": 1,
        "ç‰¹åŠ¹è–¬": 0
      };

      const weaponPower = {
        "ãªã—": 1,
        "æœ¨ã®å‰£": 3,
        "é‰„ã®å‰£": 7,
        "éŠ€ã®å‰£": 12,
        "ä¼èª¬ã®å‰£": 25
      };

      const shopTypes = {
        weapon: { name: "æ­¦å™¨å±‹", icon: "âš”ï¸", description: "å¼·ã„æ­¦å™¨ã§å†’é™ºã‚’æœ‰åˆ©ã«!", items: [] },
        item: { name: "é“å…·å±‹", icon: "ğŸ§ª", description: "å†’é™ºã«å½¹ç«‹ã¤ã‚¢ã‚¤ãƒ†ãƒ !", items: [] },
        inn: { name: "å®¿å±‹", icon: "ğŸ›ï¸", description: "ã‚†ã£ãã‚Šä¼‘ã‚“ã§ä½“åŠ›å›å¾©!", items: [] },
        armor: { name: "é˜²å…·å±‹", icon: "ğŸ›¡ï¸", description: "é ‘ä¸ˆãªé˜²å…·ã§èº«ã‚’å®ˆã‚ã†!", items: [] },
        magic: { name: "é­”æ³•å±‹", icon: "ğŸ”®", description: "ä¸æ€è­°ãªé­”æ³•ã®ã‚¢ã‚¤ãƒ†ãƒ !", items: [] }
      };

      // --- ã‚¨ãƒªã‚¢åˆ¤å®šé–¢æ•° ---
      function getArea(x, y) {
        // å·¦ä¸Š: é­”å¥³ã®å®¶ (0-16, 0-16)
        if (x < 17 && y < 17) return "witch";
        
        // å³ä¸Š: ãƒ‰ãƒ©ã‚´ãƒ³ã®å·£ (33-50, 0-10)
        if (x >= 33 && y < 10) return "dragon";
        
        // å³ä¸Š: æ¯’ã®æ²¼ (33-50, 10-17)
        if (x >= 33 && y >= 10 && y < 17) return "poison";
        
        // å³ä¸­å¤®: ã‚¹ãƒ©ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ (33-50, 17-33)
        if (x >= 33 && y >= 17 && y < 33) return "slime";
        
        // å³ä¸‹: é­”ç‹ã®åŸ (40-50, 40-50)
        if (x >= 40 && y >= 40) return "maou";
        
        // å³ä¸­ä¸‹: é­”ç‹ã®éƒ¨ä¸‹ã‚¾ãƒ¼ãƒ³ (33-40, 33-40)
        if (x >= 33 && x < 40 && y >= 33 && y < 40) return "minion";
        
        return "normal";
      }

      // --- åˆæœŸåŒ–é–¢æ•°ç¾¤ ---
      function setupShopItems() {
        shopTypes.weapon.items = [
          { name: "æœ¨ã®å‰£", price: 15, type: "weapon", desc: "æ”»æ’ƒåŠ›+3" },
          { name: "é‰„ã®å‰£", price: 50, type: "weapon", desc: "æ”»æ’ƒåŠ›+7" },
          { name: "éŠ€ã®å‰£", price: 120, type: "weapon", desc: "æ”»æ’ƒåŠ›+12" }
        ];
        shopTypes.item.items = [
          { name: "å›å¾©è–¬", price: 20, type: "item", desc: "HP20å›å¾©" },
          { name: "ãƒã‚¸ãƒƒã‚¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼", price: 30, type: "item", desc: "MP5å›å¾©" },
          { name: "ç‰¹åŠ¹è–¬", price: 80, type: "item", desc: "HPå…¨å›å¾©" }
        ];
        shopTypes.inn.items = [
          { name: "ä¼‘æ†©", price: 15, type: "rest", desc: "HP/MPå°‘ã—å›å¾©" },
          { name: "å®¿æ³Š", price: 40, type: "rest", desc: "HP/MPå…¨å›å¾©" }
        ];
        shopTypes.armor.items = [
          { name: "é©ã®é§", price: 25, type: "info", desc: "æ¬¡å›å®Ÿè£…äºˆå®š" },
          { name: "é‰„ã®é§", price: 60, type: "info", desc: "æ¬¡å›å®Ÿè£…äºˆå®š" }
        ];
        shopTypes.magic.items = [
          { name: "é­”æ³•ã®çŸ³", price: 45, type: "info", desc: "æ¬¡å›å®Ÿè£…äºˆå®š" },
          { name: "ãƒ†ãƒ¬ãƒãƒ¼ãƒˆçŸ³", price: 100, type: "info", desc: "æ¬¡å›å®Ÿè£…äºˆå®š" }
        ];
      }

      function generateMap() {
        mapData = [];
        areaData = [];
        cityData = {};
        let legendaryShopPlaced = false;

        for (let y = 0; y < MAP_SIZE; y++) {
          let row = [];
          let areaRow = [];
          for (let x = 0; x < MAP_SIZE; x++) {
            const area = getArea(x, y);
            areaRow.push(area);
            
            let tile = 0;
            
            // ç‰¹åˆ¥ãªå»ºç‰©ã®é…ç½®
            if (area === "witch" && x === 8 && y === 8) {
              tile = 100; // é­”å¥³ã®å®¶
              cityData[`${x},${y}`] = "witch_house";
            } else if (area === "dragon" && x === 41 && y === 5) {
              tile = 101; // ãƒ‰ãƒ©ã‚´ãƒ³ã®å·£
              cityData[`${x},${y}`] = "dragon_nest";
            } else if (area === "maou" && x === 45 && y === 45) {
              tile = 102; // é­”ç‹ã®åŸ
              cityData[`${x},${y}`] = "maou_castle";
            } else {
              // ã‚¨ãƒªã‚¢ã”ã¨ã®æ•µå‡ºç¾ç‡
              let enemyChance = 0.06;
              let cityChance = 0.012;
              
              if (area === "witch") enemyChance = 0.08;
              else if (area === "dragon") enemyChance = 0.10;
              else if (area === "poison") enemyChance = 0.12;
              else if (area === "slime") enemyChance = 0.15;
              else if (area === "minion") enemyChance = 0.14;
              else if (area === "maou") enemyChance = 0.18;
              
              if (Math.random() < enemyChance) {
                tile = 2; // æ•µ
              } else if (Math.random() < cityChance) {
                tile = 1; // è¡—
                const shopTypeKeys = Object.keys(shopTypes);
                let shopType = shopTypeKeys[Math.floor(Math.random() * shopTypeKeys.length)];
                
                if (!legendaryShopPlaced && Math.random() < 0.05) {
                  shopType = "legendary_weapon";
                  legendaryShopPlaced = true;
                }
                cityData[`${x},${y}`] = shopType;
              }
            }
            
            row.push(tile);
          }
          mapData.push(row);
          areaData.push(areaRow);
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹å‘¨è¾ºå®‰å…¨åŒ–
        for(let y=playerY-2; y<=playerY+2; y++){
          for(let x=playerX-2; x<=playerX+2; x++){
            if(y>=0 && y<MAP_SIZE && x>=0 && x<MAP_SIZE) {
              if(mapData[y][x] === 2) mapData[y][x] = 0;
            }
          }
        }
        
        // æœ€åˆã®è¡—
        mapData[playerY][playerX-2] = 1;
        cityData[`${playerX-2},${playerY}`] = "weapon";
      }

      function showMessage(text) {
        messageBox.textContent = text;
        messageBox.classList.remove("hidden");
        setTimeout(() => { messageBox.classList.add("hidden"); }, 2000);
      }

      function updateDisplays() {
        goldDisplay.textContent = `ğŸ’°:${gold} G`;
        weaponDisplay.textContent = `âš”ï¸:${weapon}`;
        mpDisplay.textContent = `ğŸ’§:${playerMP}`;
        const currentArea = areaData[playerY][playerX];
        areaDisplay.textContent = `ç¾åœ¨åœ°: ${areaNames[currentArea]}`;
      }

      function drawField() {
        field.innerHTML = "";
        const startX = playerX - VIEW_RADIUS;
        const startY = playerY - VIEW_RADIUS;

        for (let y = startY; y < startY + VIEW_SIZE; y++) {
          for (let x = startX; x < startX + VIEW_SIZE; x++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");

            if (x < 0 || x >= MAP_SIZE || y < 0 || y >= MAP_SIZE) {
              cell.classList.add("tile-wall");
            } else {
              const tile = mapData[y][x];
              const area = areaData[y][x];
              
              // ç‰¹åˆ¥ãªå»ºç‰©
              if (tile === 100) {
                cell.classList.add("tile-special-building", "tile-witch-house");
              } else if (tile === 101) {
                cell.classList.add("tile-special-building", "tile-dragon-nest");
              } else if (tile === 102) {
                cell.classList.add("tile-special-building", "tile-maou-castle");
              } else if (tile === 1) {
                cell.classList.add("tile-city");
              } else if (tile === 2) {
                // ã‚¨ãƒªã‚¢ã”ã¨ã®æ•µè¡¨ç¤º
                cell.classList.add("tile-enemy", `tile-${area}-enemy`);
                if (area !== "normal") {
                  cell.classList.add(`tile-${area}-area`);
                }
              } else {
                // èƒŒæ™¯è‰²ã‚’ã‚¨ãƒªã‚¢ã”ã¨ã«å¤‰æ›´
                if (area === "normal") {
                  cell.classList.add("tile-empty");
                } else {
                  cell.classList.add(`tile-${area}-area`);
                }
              }
            }
            field.appendChild(cell);
          }
        }
        
        if(!document.querySelector('.player-marker')){
            const marker = document.createElement('div');
            marker.classList.add('player-marker');
            screenArea.appendChild(marker);
        }
      }

      function openShop() {
        const cityKey = `${playerX},${playerY}`;
        const shopType = cityData[cityKey];
        currentShop.innerHTML = "";

        // ç‰¹åˆ¥ãªå»ºç‰©
        if (shopType === "witch_house") {
          townName.textContent = "ğŸ§™â€â™€ï¸ é­”å¥³ã®å®¶";
          shopIcon.textContent = "ğŸšï¸";
          shopDescription.textContent = "å‘ªã‚ã‚ŒãŸå“ç‰©ãŒä¸¦ã‚“ã§ã„ã‚‹â€¦";
          
          const items = [
            { name: "å‘ªã„ã®æ–", price: 200, type: "info", desc: "ä½¿ã†ã¨å‘ªã‚ã‚Œã‚‹ï¼Ÿ" },
            { name: "é­”å¥³ã®è–¬", price: 100, type: "item", desc: "è¬ã®åŠ¹æœâ€¦" },
            { name: "é»’é­”è¡“ã®æ›¸", price: 500, type: "info", desc: "èª­ã‚ãªã„æ–‡å­—ãŒæ›¸ã„ã¦ã‚ã‚‹" }
          ];
          
          items.forEach(item => {
            const btn = document.createElement("button");
            btn.className = "item-btn";
            btn.style.background = "linear-gradient(45deg, #4a148c, #6a1b9a)";
            btn.dataset.name = item.name;
            btn.dataset.price = item.price;
            btn.dataset.type = item.type;
            btn.textContent = `${item.name} (${item.price}G) - ${item.desc}`;
            btn.addEventListener("click", () => handlePurchase(item));
            currentShop.appendChild(btn);
          });
          
        } else if (shopType === "dragon_nest") {
          townName.textContent = "ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³ã®å·£";
          shopIcon.textContent = "ğŸ”ï¸";
          shopDescription.textContent = "ãƒ‰ãƒ©ã‚´ãƒ³ã®å®ç‰©ãŒçœ ã‚‹â€¦";
          
          const items = [
            { name: "ç«œã®ç‰™", price: 300, type: "info", desc: "ä¼èª¬ã®ç´ æ" },
            { name: "ç«œã®é±—", price: 250, type: "info", desc: "ç¡¬ã„é˜²å…·ã«ãªã‚Šãã†" },
            { name: "ä¼èª¬ã®å‰£", price: 500, type: "weapon", desc: "æ”»æ’ƒåŠ›+25", legendary: true }
          ];
          
          items.forEach(item => {
            const btn = document.createElement("button");
            btn.className = "item-btn";
            if (item.legendary) btn.classList.add("legendary-item");
            else btn.style.background = "linear-gradient(45deg, #b71c1c, #d32f2f)";
            btn.dataset.name = item.name;
            btn.dataset.price = item.price;
            btn.dataset.type = item.type;
            btn.textContent = `${item.name} (${item.price}G) - ${item.desc}`;
            btn.addEventListener("click", () => handlePurchase(item));
            currentShop.appendChild(btn);
          });
          
        } else if (shopType === "maou_castle") {
          townName.textContent = "ğŸ‘¹ é­”ç‹ã®åŸ";
          shopIcon.textContent = "ğŸ°";
          shopDescription.textContent = "ã“ã“ãŒæœ€å¾Œã®æˆ¦ã„ã®å ´â€¦";
          
          const items = [
            { name: "å‹‡è€…ã®è¨¼", price: 1000, type: "info", desc: "é­”ç‹ã‚’å€’ã—ãŸè¨¼" },
            { name: "æœ€å¾Œã®ç‰¹åŠ¹è–¬", price: 150, type: "item", desc: "HPå…¨å›å¾©" },
            { name: "é­”ç‹ã®ç‰åº§", price: 9999, type: "info", desc: "åº§ã‚Œã¾ã›ã‚“" }
          ];
          
          items.forEach(item => {
            const btn = document.createElement("button");
            btn.className = "item-btn";
            btn.style.background = "linear-gradient(45deg, #1a1a1a, #424242)";
            btn.style.color = "#ff0000";
            btn.dataset.name = item.name;
            btn.dataset.price = item.price;
            btn.dataset.type = item.type;
            btn.textContent = `${item.name} (${item.price}G) - ${item.desc}`;
            btn.addEventListener("click", () => handlePurchase(item));
            currentShop.appendChild(btn);
          });
          
        } else if (shopType === "legendary_weapon") {
          townName.textContent = "âœ¨ ä¼èª¬ã®æ­¦å™¨å±‹ âœ¨";
          shopIcon.textContent = "ğŸ‘‘";
          shopDescription.textContent = "ä¼èª¬ã®æ­¦å™¨ã‚’æ‰±ã†ç‰¹åˆ¥ãªåº—!";
          
          const items = [
            { name: "æœ¨ã®å‰£", price: 15, type: "weapon", desc: "æ”»æ’ƒåŠ›+3" },
            { name: "é‰„ã®å‰£", price: 50, type: "weapon", desc: "æ”»æ’ƒåŠ›+7" },
            { name: "éŠ€ã®å‰£", price: 120, type: "weapon", desc: "æ”»æ’ƒåŠ›+12" },
            { name: "ä¼èª¬ã®å‰£", price: 500, type: "weapon", desc: "æ”»æ’ƒåŠ›+25", legendary: true }
          ];
          
          items.forEach(item => {
            const btn = document.createElement("button");
            btn.className = "item-btn";
            if (item.legendary) btn.classList.add("legendary-item");
            btn.dataset.name = item.name;
            btn.dataset.price = item.price;
            btn.dataset.type = item.type;
            btn.textContent = `${item.name} (${item.price}G) - ${item.desc}`;
            btn.addEventListener("click", () => handlePurchase(item));
            currentShop.appendChild(btn);
          });
          
        } else if (shopTypes[shopType]) {
          const shop = shopTypes[shopType];
          townName.textContent = shop.name;
          shopIcon.textContent = shop.icon;
          shopDescription.textContent = shop.description;
          
          shop.items.forEach(item => {
            const btn = document.createElement("button");
            btn.className = "item-btn";
            btn.dataset.name = item.name;
            btn.dataset.price = item.price;
            btn.dataset.type = item.type;
            btn.textContent = `${item.name} (${item.price}G) - ${item.desc}`;
            btn.addEventListener("click", () => handlePurchase(item));
            currentShop.appendChild(btn);
          });
        }
      }

      function handlePurchase(item) {
        if (gold >= item.price) {
          gold -= item.price;
          
          if(item.type === "weapon"){
            weapon = item.name;
            showMessage(`${weapon}ã‚’è£…å‚™ã—ãŸ!`);
          } else if(item.type === "item"){
            if(item.name === "æœ€å¾Œã®ç‰¹åŠ¹è–¬" || item.name === "ç‰¹åŠ¹è–¬") {
              items["ç‰¹åŠ¹è–¬"] = (items["ç‰¹åŠ¹è–¬"] || 0) + 1;
              showMessage(`ç‰¹åŠ¹è–¬ã‚’æ‰‹ã«å…¥ã‚ŒãŸ!`);
            } else if(item.name === "é­”å¥³ã®è–¬") {
              // ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœ
              if(Math.random() < 0.5) {
                playerHP = Math.min(playerHP + 30, maxHP);
                showMessage("é­”å¥³ã®è–¬ã§ä½“åŠ›å›å¾©!");
              } else {
                playerHP = Math.max(1, playerHP - 10);
                showMessage("é­”å¥³ã®è–¬ã§ä½“åŠ›ãŒæ¸›ã£ãŸâ€¦");
              }
              updateHP();
            } else {
              items[item.name] = (items[item.name] || 0) + 1;
              showMessage(`${item.name}ã‚’æ‰‹ã«å…¥ã‚ŒãŸ!`);
            }
          } else if(item.type === "rest"){
            if(item.name === "ä¼‘æ†©"){
              playerHP = Math.min(playerHP + 15, maxHP);
              playerMP = Math.min(playerMP + 3, maxMP);
              showMessage("å°‘ã—ä¼‘ã‚“ã ã€‚ä½“åŠ›ãŒå›å¾©ã—ãŸ!");
            } else {
              playerHP = maxHP;
              playerMP = maxMP;
              showMessage("ãã£ã™ã‚Šçœ ã£ãŸã€‚ä½“åŠ›ãŒå…¨å›å¾©ã—ãŸ!");
            }
            updateHP();
          } else if(item.type === "info"){
            showMessage("ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™!");
          }
          updateDisplays();
        } else {
          showMessage("ãŠé‡‘ãŒè¶³ã‚Šãªã„ã‚ˆã†ã â€¦â€¦ã€‚");
        }
      }

      function movePlayer(dx, dy) {
        if (inTown) {
          inTown = false;
          town.classList.add("hidden");
          return;
        }
        if (inBattle) return;

        const newX = playerX + dx;
        const newY = playerY + dy;

        if (newX >= 0 && newX < MAP_SIZE && newY >= 0 && newY < MAP_SIZE) {
          playerX = newX;
          playerY = newY;
          drawField();
          updateDisplays();

          const tile = mapData[newY][newX];
          if (tile === 1 || tile >= 100) {
            inTown = true;
            town.classList.remove("hidden");
            openShop();
            showMessage("è¡—ã«ã¤ã„ãŸ!");
          } else if (tile === 2) {
            const area = areaData[newY][newX];
            currentEnemy = area;
            startBattle();
          }
        }
      }

      // --- æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯ ---
      function startBattle() {
        inBattle = true;
        battle.classList.remove("hidden");
        
        if (musicEnabled) {
          fieldBGM.pause();
          fieldBGM.currentTime = 0;
          battleBGM.play().catch(e => console.log("æˆ¦é—˜æ›²ã‚¨ãƒ©ãƒ¼:", e));
        }
        
        // ã‚¨ãƒªã‚¢ã”ã¨ã®æ•µã®å¼·ã•
        let baseHP = 15;
        let enemyName = "é­”ç‰©";
        
        if (currentEnemy === "witch") {
          baseHP = 20;
          enemyName = "é­”å¥³ã®æ‰‹ä¸‹";
        } else if (currentEnemy === "dragon") {
          baseHP = 35;
          enemyName = "ãƒ‰ãƒ©ã‚´ãƒ³";
        } else if (currentEnemy === "poison") {
          baseHP = 25;
          enemyName = "æ¯’ã‚¬ã‚¨ãƒ«";
        } else if (currentEnemy === "slime") {
          baseHP = 18;
          enemyName = "ã‚¹ãƒ©ã‚¤ãƒ ";
        } else if (currentEnemy === "minion") {
          baseHP = 30;
          enemyName = "é­”ç‹ã®éƒ¨ä¸‹";
        } else if (currentEnemy === "maou") {
          baseHP = 50;
          enemyName = "é­”ç‹è»å›£";
        }
        
        const enemyLevel = Math.floor(Math.random() * 3);
        enemyHP = baseHP + (enemyLevel * 5);

        // ã‚¨ãƒªã‚¢ã”ã¨ã®æ•µç”»åƒé¸æŠ
        const imageList = enemyImages[currentEnemy] || enemyImages.normal;
        const selectedImg = imageList[Math.floor(Math.random() * imageList.length)];
        battleEnemyImg.src = selectedImg;
        
        battleLog.textContent = `${enemyName}ãŒã‚ã‚‰ã‚ã‚ŒãŸ!`;
        updateHP();
        magicMenu.classList.add("hidden");
        itemMenu.classList.add("hidden");
      }

      function updateHP() {
        playerHPText.textContent = `å‹‡è€…HP:${playerHP}/${maxHP}`;
        enemyHPText.textContent = `æ•µHP:${enemyHP}`;
      }

      function enemyTurn() {
        if(!inBattle) return;
        
        // ã‚¨ãƒªã‚¢ã”ã¨ã®æ•µã®æ”»æ’ƒåŠ›
        let baseDamage = 3;
        if (currentEnemy === "dragon") baseDamage = 8;
        else if (currentEnemy === "poison") baseDamage = 5;
        else if (currentEnemy === "minion") baseDamage = 6;
        else if (currentEnemy === "maou") baseDamage = 10;
        
        const damage = Math.floor(Math.random() * 6) + baseDamage;
        playerHP -= damage;
        battleLog.textContent = `æ•µã®æ”»æ’ƒ!${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ!`;
        updateHP();

        if (playerHP <= 0) {
          battleLog.textContent = "å‹‡è€…ã¯å€’ã‚Œã¦ã—ã¾ã£ãŸâ€¦â€¦ã€‚";
          setTimeout(() => {
            alert("GAME OVER...");
            location.reload();
          }, 1500);
        }
      }

      // ã‚³ãƒãƒ³ãƒ‰
      document.querySelectorAll(".command").forEach(btn => {
        btn.addEventListener("click", () => {
          if (!inBattle) return;
          const cmd = btn.textContent;
          magicMenu.classList.add("hidden");
          itemMenu.classList.add("hidden");

          if (cmd === "æˆ¦ã†") {
            const base = Math.floor(Math.random() * 5) + 3;
            const damage = base + weaponPower[weapon];
            enemyHP -= damage;
            battleLog.textContent = `å‹‡è€…ã®æ”»æ’ƒ!${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
            updateHP();
            checkWinOrTurn();
          } else if (cmd === "ã«ã’ã‚‹") {
            // ã‚¨ãƒªã‚¢ã”ã¨ã®é€ƒèµ°æˆåŠŸç‡
            let escapeChance = 0.6;
            if (currentEnemy === "dragon") escapeChance = 0.3;
            else if (currentEnemy === "maou") escapeChance = 0.2;
            
            if(Math.random() < escapeChance){
                battleLog.textContent = "ã†ã¾ãã«ã’ãã‚ŒãŸ!";
                setTimeout(endBattle, 1000);
            } else {
                battleLog.textContent = "ã«ã’ã‚‰ã‚Œãªã‹ã£ãŸ!";
                setTimeout(enemyTurn, 1000);
            }
          } else if (cmd === "ã¾ã»ã†") {
            magicMenu.classList.remove("hidden");
          } else if (cmd === "ã©ã†ã") {
            itemMenu.classList.remove("hidden");
          }
        });
      });

      function checkWinOrTurn() {
        if (enemyHP <= 0) {
          // ã‚¨ãƒªã‚¢ã”ã¨ã®å ±é…¬
          let baseGold = 20;
          if (currentEnemy === "dragon") baseGold = 50;
          else if (currentEnemy === "maou") baseGold = 80;
          else if (currentEnemy === "minion") baseGold = 40;
          
          const earned = baseGold + Math.floor(Math.random() * 30);
          gold += earned;
          updateDisplays();
          battleLog.textContent = `æ•µã‚’ãŸãŠã—ãŸ!${earned}Gæ‰‹ã«å…¥ã‚ŒãŸ!`;
          mapData[playerY][playerX] = 0;
          drawField();
          setTimeout(endBattle, 1500);
        } else {
          setTimeout(enemyTurn, 1200);
        }
      }

      function endBattle() {
        inBattle = false;
        battle.classList.add("hidden");
        currentEnemy = null;
        
        if (musicEnabled) {
          battleBGM.pause();
          battleBGM.currentTime = 0;
          fieldBGM.play().catch(e => console.log("Fæ›²ã‚¨ãƒ©ãƒ¼:", e));
        }
      }

      // é­”æ³•ãƒ»ã‚¢ã‚¤ãƒ†ãƒ 
      document.querySelectorAll(".magic-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const cost = Number(btn.dataset.cost);
          if(playerMP < cost){ showMessage("MPãŒè¶³ã‚Šãªã„!"); return;}
          playerMP -= cost;
          updateDisplays();
          if(btn.dataset.name === "ãƒ•ã‚¡ã‚¤ã‚¢"){
              const dmg = 15 + Math.floor(Math.random()*5);
              enemyHP -= dmg;
              battleLog.textContent = `ãƒ•ã‚¡ã‚¤ã‚¢!æ•µã«${dmg}ã®å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
          } else {
              playerHP = maxHP;
              battleLog.textContent = `ãƒ’ãƒ¼ãƒ«!HPãŒå…¨å›å¾©ã—ãŸ!`;
          }
          updateHP();
          magicMenu.classList.add("hidden");
          checkWinOrTurn();
        });
      });

      document.querySelectorAll(".item-use-btn").forEach(btn => {
          btn.addEventListener("click", () => {
              const name = btn.dataset.name;
              if(items[name] > 0){
                  items[name]--;
                  if(name === "å›å¾©è–¬"){
                      playerHP = Math.min(playerHP + 20, maxHP);
                      battleLog.textContent = "å›å¾©è–¬ã‚’ä½¿ã£ãŸ!HPãŒ20å›å¾©ã—ãŸã€‚";
                  } else if(name === "ãƒã‚¸ãƒƒã‚¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼"){
                      playerMP = Math.min(playerMP + 5, maxMP);
                      battleLog.textContent = "ãƒã‚¸ãƒƒã‚¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã£ãŸ!MPãŒ5å›å¾©ã—ãŸã€‚";
                  } else if(name === "ç‰¹åŠ¹è–¬"){
                      playerHP = maxHP;
                      battleLog.textContent = "ç‰¹åŠ¹è–¬ã‚’ä½¿ã£ãŸ!HPãŒå…¨å›å¾©ã—ãŸ!";
                  }
                  updateHP();
                  updateDisplays();
                  itemMenu.classList.add("hidden");
                  setTimeout(enemyTurn, 1000);
              } else {
                  showMessage(`${name}ã‚’æŒã£ã¦ã„ãªã„!`);
              }
          });
      });

      // ã‚­ãƒ¼æ“ä½œ
      const handleInput = (key) => {
          if(key === "ArrowUp" || key === "up") movePlayer(0, -1);
          if(key === "ArrowDown" || key === "down") movePlayer(0, 1);
          if(key === "ArrowLeft" || key === "left") movePlayer(-1, 0);
          if(key === "ArrowRight" || key === "right") movePlayer(1, 0);
      };
      document.addEventListener("keydown", (e) => handleInput(e.key));
      ["up","down","left","right"].forEach(id => {
          document.getElementById(id).addEventListener("click", () => handleInput(id));
      });

      // ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—
      setupShopItems();
      generateMap();
      updateDisplays();
      drawField();
    });
  </script>
</body>
</html>
